name: Deploy Documentation

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  deploy-docs:
    name: Generate and Deploy Documentation
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Generate documentation
        run: Scripts/generate-docs.sh

      - name: Deploy to GitHub Pages
        run: |
          rm -rf Docs
          git checkout $GITHUB_SHA
          git config user.email "$(git show -s --format='%ae' HEAD)"
          git config user.name "$(git show -s --format='%an' HEAD)"
          rm -rf /tmp/public
          cp -r Docs /tmp/public
          echo "===== Contents of /tmp/public/documentation ====="
          ls /tmp/public/documentation
          git checkout gh-pages
          rm -rf ./*
          echo "===== Current directory contents ====="
          ls
          cp -r /tmp/public/. ./
          echo "===== New contents ====="
          ls documentation
          git add .
          git commit -m "Deploy $GITHUB_SHA" || true
          git push origin gh-pages || true
