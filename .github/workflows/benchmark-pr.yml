name: Benchmark

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
    paths:
      - 'Sources/TOMLDecoder/**/*.swift'

env:
  TOMLDECODER_BENCHMARKS: "1"

jobs:
  benchmark-delta:
    name: PR vs main
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      issues: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Ubuntu deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libjemalloc-dev

      - name: Git URL token override and misc
        run: |
          [ -d Benchmarks ] && echo "hasBenchmark=1" >> $GITHUB_ENV
          echo "/opt/homebrew/bin:/usr/local/bin" >> $GITHUB_PATH

      - name: Cache SwiftPM artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swiftpm-benchmark-${{ hashFiles('**/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-swiftpm-benchmark

      - name: Run benchmarks for PR branch
        if: ${{ env.hasBenchmark == '1' }}
        run: |
          swift package --allow-writing-to-directory .benchmarkBaselines/ benchmark baseline update pull_request --no-progress --quiet

      - name: Switch to branch 'main'
        if: ${{ env.hasBenchmark == '1' }}
        run: |
          git stash
          git checkout main

      - name: Run benchmarks for branch 'main'
        if: ${{ env.hasBenchmark == '1' }}
        run: |
          swift package --allow-writing-to-directory .benchmarkBaselines/ benchmark baseline update main --no-progress --quiet

      - name: Compare PR and main
        if: ${{ env.hasBenchmark == '1' }}
        id: benchmark
        run: |
          set -eo pipefail
          COMMENT_FILE="benchmark_comment.md"
          touch "$COMMENT_FILE"
          swift package benchmark baseline compare main pull_request --no-progress --quiet --format markdown --grouping metric >> "$COMMENT_FILE"
          cat "$COMMENT_FILE" >> "$GITHUB_STEP_SUMMARY"

          # Expose full comment as step output
          {
            echo "comment<<EOF"
            cat "$COMMENT_FILE"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Comment PR with benchmark result
        if: ${{ env.hasBenchmark == '1' }}
        uses: thollander/actions-comment-pull-request@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          message: ${{ steps.benchmark.outputs.comment }}
          comment-tag: execution

      - name: Exit with correct status
        if: ${{ env.hasBenchmark == '1' }}
        run: |
          exit ${{ env.exitStatus }}
