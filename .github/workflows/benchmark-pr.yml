name: Benchmark

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]

env:
  TOMLDECODER_BENCHMARKS: "1"

jobs:
  benchmark-delta:
    name: PR vs main
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    permissions:
      issues: write
      pull-requests: write

    strategy:
      matrix:
        os: [ubuntu-latest]

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Homebrew Mac
        if: ${{ runner.os == 'macOS' }}
        run: |
          echo "/opt/homebrew/bin:/usr/local/bin" >> $GITHUB_PATH
          brew install jemalloc

      - name: Ubuntu deps
        if: ${{ runner.os == 'Linux' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y libjemalloc-dev

      - name: Git URL token override and misc
        run: |
          #/usr/bin/ordo-performance
          [ -d Benchmarks ] && echo "hasBenchmark=1" >> $GITHUB_ENV
          echo "/opt/homebrew/bin:/usr/local/bin" >> $GITHUB_PATH

      - name: Run benchmarks for PR branch
        if: ${{ env.hasBenchmark == '1' }}
        run: |
          swift package --allow-writing-to-directory .benchmarkBaselines/ benchmark baseline update pull_request --no-progress --quiet

      - name: Switch to branch 'main'
        if: ${{ env.hasBenchmark == '1' }}
        run: |
          git stash
          git checkout main

      - name: Run benchmarks for branch 'main'
        if: ${{ env.hasBenchmark == '1' }}
        run: |
          swift package --allow-writing-to-directory .benchmarkBaselines/ benchmark baseline update main --no-progress --quiet

      - name: Compare PR and main
        if: ${{ env.hasBenchmark == '1' }}
        id: benchmark
        run: |
          set -eo pipefail

          COMMENT_FILE="benchmark_comment.md"

          # Header
          {
            echo "## Pull request benchmark comparison [${{ matrix.os }}]"
            echo
            echo "_Run at $(date -Iseconds)_"
            echo
            echo "Baseline: \`main\`"
            echo "Candidate: \`pull_request\`"
            echo
            echo "### Baseline check"
          } > "$COMMENT_FILE"

          # Run baseline check and capture exit status (regressions vs ok)
          if swift package benchmark baseline check main pull_request --format markdown >> "$COMMENT_FILE"; then
            echo >> "$COMMENT_FILE"
            echo "_No performance regressions detected._" >> "$COMMENT_FILE"
            echo "exitStatus=0" >> $GITHUB_ENV
          else
            echo >> "$COMMENT_FILE"
            echo "_Pull request had performance regressions._" >> "$COMMENT_FILE"
            echo "exitStatus=1" >> $GITHUB_ENV
          fi

          echo >> "$COMMENT_FILE"
          echo "---" >> "$COMMENT_FILE"
          echo >> "$COMMENT_FILE"
          echo "### Baseline comparison" >> "$COMMENT_FILE"

          # Detailed comparison
          swift package benchmark baseline compare main pull_request --no-progress --quiet --format markdown >> "$COMMENT_FILE"

          # Also show in the job summary
          cat "$COMMENT_FILE" >> "$GITHUB_STEP_SUMMARY"

          # Expose full comment as step output
          {
            echo "comment<<EOF"
            cat "$COMMENT_FILE"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Comment PR with benchmark result
        if: ${{ env.hasBenchmark == '1' }}
        uses: thollander/actions-comment-pull-request@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          message: ${{ steps.benchmark.outputs.comment }}
          comment_includes: "Pull request benchmark comparison [${{ matrix.os }}]"

      - name: Exit with correct status
        if: ${{ env.hasBenchmark == '1' }}
        run: |
          exit ${{ env.exitStatus }}
