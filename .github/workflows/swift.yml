name: Swift Tests
on: [push]
jobs:
  swift-test:
    name: ${{ matrix.os_name }} (Swift ${{ matrix.swift_version }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            os_name: Ubuntu 24.04
            swift_version: "6.0"
          - os: ubuntu-24.04
            os_name: Ubuntu 24.04
            swift_version: "6.2"
          - os: windows-2025
            os_name: Windows 2025
            swift_version: "6.2"
          - os: macos-15
            os_name: macOS 15
            swift_version: "6.0"
          - os: macos-15
            os_name: macOS 15
            swift_version: "6.2"
          - os: macos-26
            os_name: macOS 26
            swift_version: "6.0"
          - os: macos-26
            os_name: macOS 26
            swift_version: "6.2"
    steps:
      - uses: SwiftyLab/setup-swift@latest
        with:
          swift-version: ${{ matrix.swift_version }}
      - name: Checkout source
        uses: actions/checkout@v4
      - name: Run tests
        run: swift test

  simulator-test:
    name: ${{ matrix.platform }} ${{ matrix.os_version }}
    runs-on: macos-26
    strategy:
      matrix:
        include:
          - platform: iOS
            os_version: "18.5"
            destination: "platform=iOS Simulator,name=iPhone 16 Pro,OS=18.5"
            sdk: iphonesimulator
            device_type_id: com.apple.CoreSimulator.SimDeviceType.iPhone-16-Pro
          - platform: tvOS
            os_version: "18.5"
            destination: "platform=tvOS Simulator,name=Apple TV,OS=18.5"
            sdk: appletvsimulator
            device_type_id: com.apple.CoreSimulator.SimDeviceType.Apple-TV-1080p
          - platform: watchOS
            os_version: "11.5"
            destination: "platform=watchOS Simulator,name=Apple Watch Series 10 (46mm),OS=11.5"
            sdk: watchsimulator
            device_type_id: com.apple.CoreSimulator.SimDeviceType.Apple-Watch-Series-10-46mm
          - platform: visionOS
            os_version: "2.5"
            destination: "platform=visionOS Simulator,name=Apple Vision Pro,OS=2.5"
            sdk: xrsimulator
            device_type_id: com.apple.CoreSimulator.SimDeviceType.Apple-Vision-Pro
          - platform: iOS
            os_version: "26.1"
            destination: "platform=iOS Simulator,name=iPhone 17 Pro,OS=26.1"
            sdk: iphonesimulator
            device_type_id: com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro
          - platform: tvOS
            os_version: "26.1"
            destination: "platform=tvOS Simulator,name=Apple TV,OS=26.1"
            sdk: appletvsimulator
            device_type_id: com.apple.CoreSimulator.SimDeviceType.Apple-TV-1080p
          - platform: watchOS
            os_version: "26.1"
            destination: "platform=watchOS Simulator,name=Apple Watch Series 11 (46mm),OS=26.1"
            sdk: watchsimulator
            device_type_id: com.apple.CoreSimulator.SimDeviceType.Apple-Watch-Series-11-46mm
          - platform: visionOS
            os_version: "26.1"
            destination: "platform=visionOS Simulator,name=Apple Vision Pro,OS=26.1"
            sdk: xrsimulator
            device_type_id: com.apple.CoreSimulator.SimDeviceType.Apple-Vision-Pro
    steps:
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.1.1.app
      - name: Checkout source
        uses: actions/checkout@v4
      - name: Cache exported simulator runtime
        id: cache-runtime
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/simruntimes/${{ matrix.platform }}/${{ matrix.os_version }}
          key: simruntime-${{ runner.os }}-xcode26_1_1-${{ matrix.platform }}-${{ matrix.os_version }}
      - name: Ensure simulator runtime and device exist
        if: ${{ matrix.platform != 'macOS' }}
        env:
          SIMRUNTIME_EXPORT_BASE: ${{ runner.temp }}/simruntimes
        run: |
          Scripts/ensure-simulator.sh "${{ matrix.platform }}" "${{ matrix.os_version }}" "${{ matrix.destination }}" "${{ matrix.device_type_id }}"
      - name: Run simulator test
        run: |
          xcodebuild -scheme TOMLDecoder-Package -destination "${{ matrix.destination }}" -sdk "${{ matrix.sdk }}" test
