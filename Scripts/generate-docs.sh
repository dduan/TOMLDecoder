#!/bin/bash

set -euo pipefail

if [ "$#" -lt 1 ]; then
    base_path="/TOMLDecoder"
else
    base_path="$1"
fi

mkdir -p Docs
TOMLDECODER_DOCS=1 swift build --target TOMLDecoder \
  -Xswiftc -emit-symbol-graph \
  -Xswiftc -emit-symbol-graph-dir \
  -Xswiftc .build/symbol-graphs
TOMLDECODER_DOCS=1 swift package \
  --allow-writing-to-directory Docs \
  generate-documentation TOMLDecoder.docc \
  --target TOMLDecoder \
  --disable-indexing \
  --transform-for-static-hosting \
  --additional-symbol-graph-dir .build/symbol-graphs \
  --hosting-base-path "$base_path" \
  --output-path Docs

# Sort keys of all JSON objects generated by DocC recursively and minify
# This prevents noise from random reordering of keys from Swift.
find Docs -name "*.json" -type f -exec sh -c 'jq -c "walk(if type == \"object\" then . | to_entries | sort_by(.key) | from_entries else . end)" "$1" > "$1.tmp" && mv "$1.tmp" "$1"' _ {} \;
